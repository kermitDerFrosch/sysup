#!/bin/bash
VERSION="1.9b"

function cleanup() {
  [ -f $LOCKFILE ] && rm -f "$LOCKFILE"
  CLEANED=1
  printDuration
  [ $START -eq 1 ] && [ -f /etc/sysup/post.sh ] && source /etc/sysup/post.sh
}

function onSigInt() {
  START=0
}


! [ -f /etc/sysup/functions.inc ] && ! [ -f functions.inc ] && (echo "functions not found"; exit 1)
! [ -f /etc/sysup/sysup.conf ] && ! [ -f sysup.conf ] && (echo "Config not found"; exit 1)
! [ -f /etc/sysup/phase.conf ] && ! [ -f phase.conf ] && (echo "phases not found"; exit 1)

[ -f functions.inc ] && . functions.inc || . /etc/sysup/functions.inc
[ -f sysup.conf ] && . sysup.conf || . /etc/sysup/sysup.conf

# parse parameters
PARAMS="$@"
while [ "$1x" != "x" ];do
  parseParameter "$1"
  shift
done

# check validity of parameters
checkParameters

# Runcheck
if [ -f "$LOCKFILE" ]; then
  echo "Update is running (PID:`cat $LOCKFILE`)"
  exit 1
fi

# get root if needed
getRoot

declare -i USE_TMUX=0
declare -i FIRSTLOG=1

# open tmux if needed
startTmux

declare -i START=0
declare -A TIMES
declare -A RC
declare -a PARTS
declare -A CMDS
declare -A ERROR_MESSAGE
declare -A PARTNAMES
declare -i CLEANED=0

# define destructor and sigint-handler
trap cleanup EXIT
trap onSigInt INT

# write lockfile for runcheck
echo $$ > "$LOCKFILE"

logLine 1 "Gentoo System updater v$VERSION"

# add required parts
configureParts

[ -f phase.conf ] && . phase.conf || . /etc/sysup/phase.conf

if [ ! -d "$LOGPATH" ];then
  mkdir "$LOGPATH"
fi

START=1
[ -f /etc/sysup/pre.sh ] && source /etc/sysup/pre.sh

# run parts
for PART in ${PARTS[@]}; do
  if [ $CLEANED -eq 1 ] || [ $START -ne 1 ]; then
    break
  fi
  processPart $PART
done
